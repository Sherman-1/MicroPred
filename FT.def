BOOTSTRAP: docker
FROM: nvidia/cuda:11.7.1-cudnn8-runtime-ubuntu22.04

%files

%post
################################# APT INSTALL NON INTERATIF  ##################
export DEBIAN_FRONTEND=noninteractive
mkdir -p /tmp/apt/cache
mkdir -p /tmp/apt/lists
# Evite de tout retélécharger en créant un cache dans le /tmp du noeud
echo 'Dir::Cache "/tmp/apt/cache";' > /etc/apt/apt.conf.d/99custom
echo 'Dir::State::Lists "/tmp/apt/lists";' >> /etc/apt/apt.conf.d/99custom

apt-get clean
###############################################################################

################################# PIP INSTALL #################################
# Même chose que là haut, évite de tout retélécharger
mkdir -p /tmp/pip/cache
#pip3 --cache-dir=/tmp/pip/cache install --break-system-packages PACKAGE ...
###############################################################################

apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    wget \
    git \
    libopenmpi-dev \
    libssl-dev \
    libffi-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libjpeg-dev \
    libpng-dev \
    libopenblas-dev \
    libblas-dev \
    liblapack-dev \
    libhdf5-serial-dev \
    libcurl4-openssl-dev \
    cmake \
    make \
    g++ \
    libprotobuf-dev \
    protobuf-compiler \
    libgoogle-perftools-dev \
    python3 \
    python3-dev \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

python3 -m pip install --cache-dir=/tmp/pip/cache --upgrade pip setuptools

python3 -m pip install --cache-dir=/tmp/pip/cache \
    torch==1.13.1+cu117 \
    --extra-index-url https://download.pytorch.org/whl/cu117 && \
    python3 -m pip install --cache-dir=/tmp/pip/cache \
    numpy==1.22.3 \
    scipy==1.7.3 \
    pandas==1.5.3 \
    scikit-learn==1.2.0 \
    matplotlib==3.6.3 \
    tensorflow==2.9.1 \
    tensorboard==2.9.0 \
    transformers \
    datasets \
    evaluate \
    tokenizers==0.13.2 \
    huggingface-hub \
    pyarrow==11.0.0 \
    pillow==9.4.0 \
    accelerate==0.25.0 \
    tqdm==4.64.1 \
    requests==2.28.1 \
    protobuf==3.19.0 \
    pyyaml==6.0 \
    typing-extensions==4.4.0 \
    packaging==22.0 \
    filelock==3.9.0 \
    regex==2022.10.31 \
    ninja==1.11.1 \
    psutil==5.9.0 \
    py-cpuinfo==9.0.0 \
    pyparsing==3.0.9 \
    pydantic==1.10.5 \
    typeguard==2.13.3 \
    xxhash==3.2.0 \
    peft

git clone https://github.com/google/sentencepiece.git /sentencepiece && \
    cd /sentencepiece && \
    mkdir build && cd build && \
    cmake .. -DSPM_ENABLE_SHARED=OFF -DCMAKE_INSTALL_PREFIX=./root && \
    make install && \
    cd ../python && \
    python3 setup.py bdist_wheel && \
    python3 -m pip install dist/sentencepiece*.whl && \
    rm -rf /sentencepiece